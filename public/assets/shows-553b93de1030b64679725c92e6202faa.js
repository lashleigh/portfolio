function Show(a){return this.id=a.id,this.width=a.width,this.height=a.height,this.title=a.title,this.scripts=a.scripts,this.styles=a.styles,this.current,this.slides=[],this.num_slides,this.mode={reduced:!1,coding:!1},this.current_scale=this.max_scale(),this.interval,this.scale_all_slides(),this}function Slide(a,b){this.show=a,this.id=b.id,this.dom_id="#slide_"+b.id,this.index=b.index,this.scripts=b.scripts||"",this.dom=$(this.dom_id);var c=this;return c.dom.bind("dblclick",function(){c.show.mode.expose&&c.show.toggle_expose(c.index)}),c.dom.click(function(){c.show.mode.expose||c.handle_click()}),this.page=d3.select(this.dom_id).select("svg").attr("width",a.width).attr("height",a.height),this}function create_slideshow(a){var b=new Show(a),c=[];for(var d=0;d<a.ordered_slides.length;d++)c.push(new Slide(b,a.ordered_slides[d]));return b.slides=c,b.initialize_slides(),$(".slides").css("display","block"),$("#insert_after_currect").click(function(){b.insert_slide()}),$("#duplicate_current").click(function(){b.duplicate_slide()}),$("#delete_current").click(function(){b.current.destroy()}),$("#show_style").click(function(){b.toggle_editor("#show_style_editor")}),$("#show_js").click(function(){b.toggle_editor("#show_js_editor")}),$(document).keydown(function(a){$(a.target).parents().hasClass("CodeMirror")?a.keyCode!=27&&a.keyCode==="S".charCodeAt(0)&&a.ctrlKey&&(b.mode.coding?b.save_current():b.save_from_editor()):handleKeys(a,b)}),b}function handleKeys(a,b){switch(a.keyCode){case 37:b.move("prev");break;case 39:b.move("next");break;case 72:b.move("prev");break;case 74:b.scale_all_slides(b.current_scale*.9);break;case 75:b.scale_all_slides(b.current_scale*1.1);break;case 76:b.move("next");break;case 80:b.toggle_reduced();break;case 69:case 65:b.toggle_coding_mode();break;case 83:b.toggle_expose()}}function zoom_slides(){var a=$("#scale_slides").val()/100;slideshow&&slideshow.scale_all_slides(a)}Show.prototype.max_scale=function(a){a=a||.85;var b=window.innerWidth*a/this.width,c=window.innerHeight*a/this.height;return Math.min(b,c)},Show.prototype.fire_message=function(a){$(".presentation #message").text(a)},Show.prototype.scale_all_slides=function(a){var b=this,a=a||b.max_scale();$("#scale_slides").val(a*100),b.current_scale=a,b.update_custom_style();var c=window.innerHeight-60,d=window.innerWidth-5-b.current_scale*b.width;$("#slide_js_editor").css("width",d+"px").css("height",c+"px").css("margin-top",c*-0.5+"px"),$("#slide_js_editor .CodeMirror-scroll").css("height",c+"px !important")},Show.prototype.execute_all=function(){var a=this;for(var b=0;b<a.num_slides;b++)a.slides[b].execute()},Show.prototype.change_index_by_id=function(a){var b,c=this,d=0;while(!b&&d<c.num_slides)c.slides[d].dom_id==="#"+a&&(b=c.slides[d]),d++;if(b){var e=$(".slide").index(b.dom),f=e>b.index?-1:1;for(var d=e;d!=b.index;d+=f)c.slides[d].index+=f;b.change_index(e)}},Show.prototype.toggle_expose=function(a){var b=this;b.mode.coding&&b.toggle_coding_mode(),b.mode.expose?(b.mode.expose=!1,b.close_editor(),$(".presentation").css("overflow","hidden"),$(".slides").removeClass("gridify"),$(".slide").unwrap('<div class="expose" />'),$(".slides").sortable({disabled:!0}),$("#slide_options").show(),b.set_current_to_index(a||0)):(b.mode.expose=!0,$(".presentation").css("overflow","auto"),$(".slides").addClass("gridify"),$(".slide").removeClass("far-past past current future far-future"),$(".slide").wrap('<div class="expose" />'),$("#slide_options").hide(),$(".slides").sortable({disabled:!1,update:function(a,c){b.change_index_by_id(c.item[0].firstChild.id)}}))},Show.prototype.toggle_reduced=function(a){var b=this;b.mode.reduced?(b.mode.reduced=!1,$(".slides").removeClass("reduced")):(b.mode.reduced=!0,$(".slides").addClass("reduced"))},Show.prototype.scale_code_editor=function(){var a=this,b=document.styleSheets[0],c=window.innerHeight-40,d=window.innerWidth-5-a.current_scale*a.width;!!b.cssRules[6]&&b.cssRules[6].selectorText==="#slide_js_editor"&&(b.deleteRule(6),b.deleteRule(6)),b.insertRule("#slide_js_editor {width: "+d+"px;"+"height:"+c+"px;"+"margin-top:"+c*-0.5+"px;}",6),b.insertRule("#slide_js_editor .CodeMirror-scroll {height:"+c+"px !important;}",7)},Show.prototype.toggle_coding_mode=function(){var a=this;a.mode.coding?(a.mode.coding=!1,$("#slide_js_editor").hide(),$(".slides").removeClass("editing"),$(".presentation").after($("#slide_js_editor"))):a.mode.expose||(a.mode.coding=!0,$("#slide_js_editor").show(),$(".slides").addClass("editing"),code_editor.setValue(a.current.scripts),$(".presentation").before($("#slide_js_editor")))},Show.prototype.save_scripts=function(){var a=this;$("#show_scripts").val(show_js_editor.getValue()),$.post("/shows/"+a.id,$(".edit_show").serialize(),function(b,c){c==="success"?(a.scripts=show_js_editor.getValue(),a.execute_all()):console.log(b,c)})},Show.prototype.update_custom_style=function(){var a=this,b=a.parse_style(this.styles);if(b){if(!$("head style#show_styles")[0]){var c=document.getElementsByTagName("head")[0],d=document.createElement("style"),b=a.parse_style(a.styles);d.type="text/css",d.media="screen",d.id="show_styles",$(d).text(b),c.appendChild(d)}$("head style#show_styles").text(b)}},Show.prototype.parse_style=function(a){var b=new less.Parser,c,d="@width: "+this.width+"px;"+"@height: "+this.height+"px;"+"@current_scale: "+this.current_scale+";";return b.parse(d+a,function(a,b){a?(console.log(b),console.error(a),c=!1):c=b.toCSS()}),c===""&&(c=" "),c},Show.prototype.save_styles=function(){var a=this,b=show_style_editor.getValue(),c=a.parse_style(b);c&&($(".edit_show #show_styles").val(b),$.post("/shows/"+a.id,$(".edit_show").serialize(),function(a,b){b==="success"?$("head style#show_styles").text(c):console.log(a,b)}))},Show.prototype.save_from_editor=function(){var a=this,b;return a.mode.show_editor?a.mode.show_editor==="#show_style_editor"?a.save_styles():a.save_scripts():console.log("show editor was not open so could not save"),b},Show.prototype.open_editor=function(a){var b=this;b.mode.expose||b.toggle_expose(),a==="#show_js_editor"?$(".show_editor_wrap").append($("#show_style_editor")):$(".show_editor_wrap").append($("#show_js_editor")),$(".show_editor_wrap").show(),$(a).show()},Show.prototype.close_editor=function(){$(".show_editor_wrap").hide(),$(".show_editor").hide()},Show.prototype.toggle_editor=function(a){var b=this;b.mode.show_editor?b.mode.show_editor===a?(b.close_editor(),b.mode.show_editor=!1):(b.close_editor(),b.mode.show_editor=a,b.open_editor(a)):(b.mode.show_editor=a,b.open_editor(a))},Show.prototype.set_current_to_index=function(a){var b=this;if(b.valid_index(a)){var c="far-past past current future far-future";b.slides[a].change_classes(c,"current"),b.current=b.slides[a];if(b.valid_index(a-1)){b.slides[a-1].change_classes(c,"past");if(b.valid_index(a-2))for(var d=0;d<=a-2;d++)b.slides[d].change_classes(c,"far-past")}if(b.valid_index(a+1)){b.slides[a+1].change_classes(c,"future");if(b.valid_index(a+2))for(var d=a+2;d<b.num_slides;d++)b.slides[d].change_classes(c,"far-future")}}},Show.prototype.initialize_slides=function(){var a=this;a.num_slides=a.slides.length,a.slides[0].dom.addClass("current"),a.current=a.slides[0],a.current.execute();if(a.slides[1]){a.slides[1].dom.addClass("future"),a.slides[1].execute();if(a.slides[2])for(var b=2;b<a.num_slides;b++)a.slides[b].dom.addClass("far-future"),a.slides[b].execute()}},Show.prototype.move=function(a,b){var c=this;if(!c.mode.expose)switch(a){case"prev":c.prev();break;case"next":c.next();break;case"set":c.set_current_to_index(b||0)}},Show.prototype.next=function(){var a=this,b=a.current.index;a.valid_index(b+1)&&(a.slides[b+1].change_classes("future","current"),a.slides[b].change_classes("current","past"),a.valid_index(b-1)&&a.slides[b-1].change_classes("past","far-past"),a.valid_index(b+2)&&a.slides[b+2].change_classes("far-future","future"),a.current=a.slides[b+1],a.current.execute())},Show.prototype.prev=function(){var a=this,b=a.current.index;a.valid_index(b-1)&&(a.slides[b].change_classes("current","future"),a.slides[b-1].change_classes("past","current"),a.valid_index(b+1)&&a.slides[b+1].change_classes("future","far-future"),a.valid_index(b-2)&&a.slides[b-2].change_classes("far-past","past"),a.current=a.slides[b-1],a.current.execute())},Show.prototype.save_current=function(){this.current.scripts=code_editor.getValue(),this.current.save(),this.current.execute()},Show.prototype.valid_index=function(a){return a>=0&&a<=this.num_slides-1},Show.prototype.insert_slide=function(){var a=this;$("#new_slide #insert_id").val(a.current.id),$.post("/slides",$("#new_slide").serialize(),function(b,c){$($(".slide")[$(".slide").index(a.current.dom)]).after(b.slidehtml);var d=new Slide(a,b.slide);a.slides.splice(d.index,0,d),a.num_slides=a.slides.length;for(var e=d.index+1;e<a.num_slides;e++)a.slides[e].index+=1;d.execute(),a.set_current_to_index(d.index),$("#new_slide #copy").val(""),$("#new_slide #insert_id").val("")})},Show.prototype.duplicate_slide=function(){$("#new_slide #copy").val("true"),this.insert_slide()},Show.prototype.append_slide=function(){var a=this;$.post("/slides",$("#new_slide").serialize(),function(b,c){$(".slide").last().after(b.slidehtml);var d=new Slide(a,b.slide);a.slides.push(d),a.num_slides=a.slides.length,d.execute(),a.set_current_to_index(d.index)})},Show.prototype.append_slide=function(){},Slide.prototype.handle_click=function(){var a=this;return a.dom.hasClass("current")?!1:a.dom.hasClass("future")?(a.show.next(),"next"):a.dom.hasClass("past")?(a.show.prev(),"prev"):(a.show.set_current_to_index(a.index),"distant")},Slide.prototype.change_classes=function(a,b){this.dom.removeClass(a).addClass(b)},Slide.prototype.change_index=function(a){var b=this,c="#edit_slide_"+b.id;$(c+" #slide_index").val(a),b.show.fire_message("saving..."),$.post("/slides/"+b.id,$(c).serialize(),function(c,d){b.show.fire_message(d),d==="success"?(b.show.slides.splice(b.index,1),b.show.slides.splice(a,0,b),b.index=a,b.show.execute_all()):console.log("falied to change index",c,d)})},Slide.prototype.save=function(){$("#edit_slide_"+this.id+" #slide_scripts").val(this.scripts),$("#edit_slide_"+this.id).submit()},Slide.prototype.destroy=function(){var a=this,b=a.show;b.fire_message("deleting..."),b.num_slides>1&&($(".destroy_slide").attr("action","/slides/"+a.id),$.post("/slides/"+a.id,$(".destroy_slide").serialize(),function(c,d){b.fire_message(d);if(d==="success"){b.slides.splice(a.index,1),b.num_slides+=-1,$(a.dom_id).remove();for(var e=a.index;e<b.num_slides;e++)b.slides[e].index+=-1;a.index>0?b.set_current_to_index(a.index-1):b.set_current_to_index(0)}else console.log("failed to destroy",c,d)}))},Slide.prototype.execute=function(){var a=this;code_editor.setValue(a.scripts),$(a.dom_id+" svg").empty();var b=a.show.current_scale;clearInterval(a.show.interval);try{(new Function("page","slide","show","scale",a.show.scripts+a.scripts)).call(a.page,a.page,a,a.show,b)}catch(c){alert(c.message||c)}}