var App={Collections:{},Views:{},Models:{}};as_percent=function(a){return Math.floor(1e3*a)/10},truncate=function(a){return Math.floor(10*a)/10},App.Models.Recipe=Backbone.Model.extend({initialize:function(){this.parts=new App.Collections.PartList,this.view=new App.Views.Recipe({model:this,id:"recipe_"+this.id}),$("#recipe_container").append(this.view.render().el),this.parts.url="/recipes/"+this.id+"/parts",this.parts.recipeView=this.view,this.parts.reset(this.get("parts")),this.parts.bind("all",this.view.update_stats,this.view),this.view.update_stats()}}),App.Collections.Recipes=Backbone.Collection.extend({model:App.Models.Recipe,url:"/recipes"}),App.Views.Recipe=Backbone.View.extend({tagName:"div",className:"recipe",events:{"click .add":"newPart"},update_stats:function(){var a=_.template($("#recipe-stats").html());$(this.el).find(".stats").html(a(this.model.parts.stats())),console.log("update stats")},newPart:function(){var a=this.new_amount.val(),b=this.new_name.val(),c=this.new_name_id.val(),d=$(this.el).find(".new-unit").val();if(!a||!b)return;var e=this.model.parts.create({percent:Math.floor(1e3*a/this.model.parts.flour_mass())/10,amount:a,unit:d,ingredient_id:c,ingredient:{name:b}});!e||(this.new_amount.val(""),this.new_name.val(""),this.new_name_id.val(""))},render:function(){var a=_.template($("#recipe-li").html());return $(this.el).html(a(this.model.toJSON())),this.new_amount=$(this.el).find(".new-amount"),this.new_name=$(this.el).find("#new-name"),this.new_name_id=$(this.el).find("#new-name-id"),this}}),App.Views.Part=Backbone.View.extend({tagName:"tr",className:"parts",initialize:function(){console.log(this),this.template=this.model.get("primary")?$("#primary-part-li").html():$("#part-li").html(),$(this.model.collection.recipeView.el).find("#part-list").append(this.render().el),this.model.bind("change",this.render,this),this.model.bind("destroy",this.remove,this)},events:{"click .amount":"editAmount","click .name":"editName","click .unit":"editUnit","click .remove":"clear","keypress .edit-amount":"updateAmountOnEnter","keypress .edit-name":"updateIngredientOnEnter"},editAmount:function(){$(this.el).addClass("editing-amount"),this.input_name.val(this.model.get("ingredient").name),this.input_amount.removeClass("hidden").focus()},editName:function(){$(this.el).addClass("editing-name"),this.input_amount.val(this.model.get("amount")),this.input_name.removeClass("hidden").focus()},editUnit:function(){$(this.el).addClass("editing-unit"),this.input_name.val(this.model.get("ingredient").name),this.input_amount.val(this.model.get("amount")),this.select_unit.removeClass("hidden").val(this.model.get("unit")).focus()},updateAmountOnEnter:function(a){if(a.keyCode==13){var b=this.input_amount.val(),c=Math.floor(1e3*b/this.model.collection.flour_mass())/10;this.model.save({amount:b,percent:c}),this.exitEditing()}},updateIngredientOnEnter:function(a){a.keyCode==13&&this.saveIngredient()},saveIngredient:function(){this.model.save({ingredient_id:this.input_name_id.val(),ingredient:{name:this.input_name.val()}}),this.exitEditing()},updateUnit:function(){this.model.save({unit:this.select_unit.val()}),this.exitEditing()},exitEditing:function(){this.input_amount.addClass("hidden"),this.input_name.addClass("hidden"),this.select_unit.addClass("hidden"),$(this.el).removeClass("editing-amount editing-name editing-unit")},remove:function(){$(this.el).remove()},clear:function(){this.model.destroy()},autocomplete:function(){var a=this;return{minLength:0,source:ingredients,focus:function(b,c){return a.input_name.val(c.item.label),!1},select:function(b,c){return a.input_name.val(c.item.label),a.input_name_id.val(c.item.value),a.saveIngredient(),!1}}},render:function(){var a=_.template(this.template);$(this.el).html(a(this.model.toJSON())),this.input_amount=$(this.el).find(".edit-amount"),this.input_name=$(this.el).find(".edit-name"),this.input_name_id=$(this.el).find(".edit-name-id"),this.select_unit=$(this.el).find(".edit-unit");var b=this.model.attributes;return this.input_amount.bind("blur",_.bind(this.exitEditing,this)).val(b.amount),this.input_name.bind("blur",_.bind(this.exitEditing,this)).val(b.ingredient.name).autocomplete(this.autocomplete()),this.select_unit.bind("blur",_.bind(this.exitEditing,this)).val(b.unit),this.select_unit.bind("change",_.bind(this.updateUnit,this)),this}}),App.Models.Part=Backbone.Model.extend({validate:function(a){var b=[];return _.isUndefined(a.amount)||(a.amount.length===0?b.push("amount is empty "):a.amount/a.amount!==1&&b.push("amount is not a number")),!!_.isUndefined(a.ingredient_id),_.isUndefined(a.ingredient)||a.ingredient.name.length<3&&b.push("ingredient name is too short"),!!_.isUndefined(a.unit),_.any(b)?b:!1},initialize:function(){if(!this.validate(this.attributes)){var a=this.id?this.id:this.cid;this.view=new App.Views.Part({model:this,id:"part_"+a})}}}),App.Collections.PartList=Backbone.Collection.extend({model:App.Models.Part,getTotalMass:function(a){return _.pluck(_.pluck(this.filter(function(b){return b.get("ingredient").name==a}),"attributes"),"amount").reduce(function(a,b){return a+b},0)},stats:function(){var a=this.getTotalMass("starter")/2,b=this.getTotalMass("water"),c=this.getTotalMass("flour"),d=a/(c+a);return{hydration:as_percent((b+a)/(c+a)),innoculation:as_percent(d),doubling:truncate(-3*Math.log(d)/Math.log(2)),temp:72}},flour_mass:function(){return this.getTotalMass("flour")+this.getTotalMass("starter")/2},initialize:function(){}})