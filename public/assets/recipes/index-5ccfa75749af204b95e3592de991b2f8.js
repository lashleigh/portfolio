function isNum(a){return!!a&&parseFloat(a)===a*1}var App={Collections:{},Views:{},Models:{}};as_percent=function(a){return Math.round(1e4*a)/100},truncate=function(a){return Math.round(100*a)/100},App.Models.Recipe=Backbone.Model.extend({url:"/recipes",initialize:function(){this.parts=new App.Collections.PartList,this.notes=new App.Collections.NoteList,this.view=new App.Views.Recipe({model:this,el:document.getElementById("recipe_container")}),this.view.render(),this.view.$el=$("#recipe_container"),this.url="/recipes/"+this.id,this.parts.url="/recipes/"+this.id+"/parts",this.parts.recipeView=this.view,this.parts.reset(this.get("parts")),this.notes.url="/recipes/"+this.id+"/notes",this.notes.recipeView=this.view,this.notes.reset(this.get("notes")),this.view.update_stats()}}),App.Views.Recipe=Backbone.View.extend({events:{"click .editable":"editFields","blur  .editable input":"exitEditField","keyup .editable input":"updateTitle","keyup input#new-amount":"updateNewPercent","keyup input#new-percent":"updateNewAmount","click .add":"newPart","click .new-note":"newNote","keyup #new-note-body":"resizeNote","focus #new-note-body":"resizeNote"},resizeNote:function(){var a=$("#new-note-body");a.css("height",a[0].scrollHeight+"px")},newNote:function(){this.model.notes.newNote()},editFields:function(a){console.log(a,$(a.currentTarget).find("input"));var b=$(a.currentTarget).find("input");b.focus().parent().addClass("editing")},exitEditField:function(a){$(a.currentTarget).parent().removeClass("editing")},updateTitle:function(a){if(a.keyCode===13){var b=this.$("#recipe-title input");this.model.save({title:b.val()}),b.prev().text(b.val()).parent().removeClass("editing")}},editTitle:function(a){this.$("#recip-title span").parent().addClass("editing"),this.$("#recipe-title input").focus()},editInnoculation:function(){this.$el.find("#inoculation").addClass("editing").find("input").focus()},exitEditInnoculation:function(){this.$el.find("#inoculation").removeClass("editing")},updateInnoculation:function(a){if(a.keyCode===13){var b=$("#inoculation input").val();if(!isNum(b))return;var c=this.model.parts.filter(function(a){return a.get("ingredient").name==="starter"})[0],d=this.model.parts.filter(function(a){return a.get("ingredient").name==="flour"})[0],e=this.model.parts.filter(function(a){return a.get("ingredient").name==="water"})[0],f=this.model.parts.flour_mass(),g=b/100*f,h=this.hydration.find("span").text();c.save({amount:truncate(g*2)}),d.save({amount:truncate(f-g)}),e.save({amount:truncate(h/100*f-g)}),this.exitEditInnoculation(),this.update_stats()}},editHydration:function(){this.hydration.addClass("editing"),this.hydration_input.focus()},exitEditHydration:function(){this.hydration.removeClass("editing")},newWaterMass:function(){var a=this.model.parts.filter(function(a){return a.get("ingredient").name==="water"})[0],b=this.hydration_input.val(),c=this.model.parts.water_mass(),d=this.model.parts.flour_mass(),e=(c-a.get("amount"))/d*100;if(e<b){var f=(b-e)/100*d,g=as_percent(f/d);a.save({amount:f,percent:g})}},updateHydrationOnEnter:function(a){a.keyCode==13&&(this.newWaterMass(),this.exitEditHydration(),this.update_stats())},updateNewPercent:function(){var a=as_percent(this.new_amount.val()/this.model.parts.flour_mass());this.new_percent.val(""),this.new_percent.attr("placeholder",a)},updateNewAmount:function(){var a=truncate(this.new_percent.val()/100*this.model.parts.flour_mass());this.new_amount.val(""),this.new_amount.attr("placeholder",a)},update_stats:function(){var a=_.template($("#recipe-stats").html());this.$("#stats").html(a(this.model.parts.stats())),this.hydration=this.$("#hydration"),this.hydration_input=this.hydration.find("input")},newPart:function(){var a=this.new_amount.val(),b=this.new_percent.val(),c=this.new_name.val(),d=this.new_name_id.val(),e=!1;if(!c)return;if(isNum(b))a=truncate(b/100*this.model.parts.flour_mass()),e=!0;else{if(!isNum(a))return;b=as_percent(a/this.model.parts.flour_mass())}var f=this.model.parts.create({percent:b,amount:a,ingredient_id:d,fixed_percent:e,ingredient:{name:c}});!f||$(this.el).find("#new-part").find("input").val("")},render:function(){return this.new_amount=$(this.el).find("#new-amount"),this.new_percent=$(this.el).find("#new-percent"),this.new_name=$(this.el).find("#new-name"),this.new_name_id=$(this.el).find("#new-name-id"),this}}),App.Views.Note=Backbone.View.extend({tagName:"div",className:"note",initialize:function(){this.template=$("#note-li").html(),$("#new-note").after(this.render().el),this.model.bind("change",this.render,this),this.setHeight(),this.$el=$(this.el)},events:{"click .body":"editBody","click .body-cancel":"exitEditBody","click .body-submit":"updateBody","click .remove":"destroy","keyup .body-input":"updateBodyHeight"},destroy:function(){this.model.destroy(),$(this.el).remove()},editBody:function(){this.$el.addClass("editing"),this.body_input.focus()},exitEditBody:function(){this.$el.removeClass("editing")},updateBody:function(){this.model.save({body:this.body_input.val()}),this.exitEditBody()},localTime:function(){var a=new Date(this.model.get("time")),b=a.getHours(),c=a.getMinutes();c<10&&(c="0"+c);var d=" am";return b>=12&&(d=" pm",b-=12),b||(b=12),b+":"+c+d},getLocalTime:function(){function d(c,d){return c<1?Math.round(c*60)+"m ago":c<4?Math.floor(c)+"h "+Math.round((c-Math.floor(c))*60)+"m ago":c<24?Math.round(c)+"h ago":c<96?Math.floor(c/24)+"d "+Math.round((c/24-Math.floor(c/24))*24)+"h ago":b.getDate()+" "+a[b.getMonth()]+" @ "+d.localTime()}var a=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],b=new Date(this.model.get("time")),c=(new Date-b)/36e5;return d(c,this)},updateBodyHeight:function(){this.body_input.css("height",this.body_input[0].scrollHeight+"px")},setHeight:function(){this.body_input.css("height",this.note_body.css("height"))},render:function(){var a=_.template(this.template);return $(this.el).html(a(this.model.toJSON())),$(this.el).find(".time").text(this.getLocalTime()),this.note_body=$(this.el).find(".body"),this.body_input=$(this.el).find(".body-input"),this.setHeight(),this}}),App.Views.Part=Backbone.View.extend({tagName:"tr",className:"part",initialize:function(){this.template=this.model.get("primary")?$("#primary-part-li").html():$("#part-li").html(),$(this.model.collection.recipeView.el).find("#part-list").append(this.render().el),this.model.bind("change",this.render,this),this.model.bind("destroy",this.remove,this)},events:{"click .editable ":"editField","click .remove":"clear","click .fixed-percent-input":"toggleFixedPercent","keypress .edit-amount":"updateAmountOnEnter","keypress .edit-name":"updateIngredientOnEnter","keypress .edit-percent":"updatePercentOnEnter"},toggleFixedPercent:function(){this.model.save({fixed_percent:!this.model.get("fixed_percent")})},editField:function(a){console.log(a),$(a.currentTarget).find("input.val").focus().parent().addClass("editing"),this.input_name.val(this.model.get("ingredient").name),this.input_amount.val(this.model.get("amount")),this.input_percent.val(this.model.get("percent"))},updatePercentOnEnter:function(a){if(a.keyCode==13){var b=truncate(this.input_percent.val()),c=truncate(b/100*this.model.collection.flour_mass());this.model.save({amount:c,percent:b})}},updateAmountOnEnter:function(a){if(a.keyCode==13){var b=truncate(this.input_amount.val()),c=as_percent(b/this.model.collection.flour_mass());this.model.save({amount:b,percent:c})}},updateIngredientOnEnter:function(a){a.keyCode==13&&this.saveIngredient()},saveIngredient:function(){this.model.save({ingredient_id:this.input_name_id.val(),ingredient:{name:this.input_name.val()}})},exitEditing:function(a){$(a.currentTarget).parent().removeClass("editing")},remove:function(){$(this.el).remove()},clear:function(){this.model.destroy()},autocomplete:function(){var a=this;return{minLength:0,source:ingredients,focus:function(b,c){return a.input_name.val(c.item.label),!1},select:function(b,c){return a.input_name.val(c.item.label),a.input_name_id.val(c.item.value),a.saveIngredient(),!1}}},render:function(){var a=_.template(this.template);$(this.el).html(a(this.model.toJSON())),this.input_amount=$(this.el).find(".edit-amount"),this.input_percent=$(this.el).find(".edit-percent"),this.input_name=$(this.el).find(".edit-name"),this.input_name_id=$(this.el).find(".edit-name-id");var b=this.model.attributes;return this.input_amount.bind("blur",_.bind(this.exitEditing,this)).val(b.amount),this.input_percent.bind("blur",_.bind(this.exitEditing,this)).val(b.percent),this.input_name.bind("blur",_.bind(this.exitEditing,this)).val(b.ingredient.name).autocomplete(this.autocomplete()),this.model.get("primary")||(this.el.getElementsByClassName("fixed-percent-input")[0].checked=this.model.get("fixed_percent")),this}}),App.Models.Part=Backbone.Model.extend({validate:function(a){var b=[];return _.isUndefined(a.amount)||(a.amount.length===0?b.push("amount is empty "):a.amount/a.amount!==1&&b.push("amount is not a number")),!!_.isUndefined(a.ingredient_id),_.isUndefined(a.ingredient)||a.ingredient.name.length<3&&b.push("ingredient name is too short"),_.any(b)?b:!1},initialize:function(){if(!this.validate(this.attributes)){var a=this.id?this.id:this.cid;this.view=new App.Views.Part({model:this,id:"part_"+a})}if(this.get("ingredient").name==="flour"||this.get("ingredient").name==="starter")this.bind("change",this.updatePercents,this),this.bind("change",this.maintainHydration,this)},maintainHydration:function(){this.collection.recipeView.newWaterMass(),this.collection.recipeView.update_stats()},updatePercents:function(){var a=this.collection.flour_mass(),b=this.collection.filter(function(a){return a!==this&&a.get("primary")===!1});_.each(b,function(b){b.get("fixed_percent")?b.save({amount:truncate(b.get("percent")/100*a)}):b.save({percent:as_percent(b.get("amount")/a)})})}}),App.Collections.PartList=Backbone.Collection.extend({model:App.Models.Part,getTotalMass:function(a){return _.pluck(_.pluck(this.filter(function(b){return b.get("ingredient").name==a}),"attributes"),"amount").reduce(function(a,b){return parseFloat(a)+parseFloat(b)},0)},stats:function(){var a=this.getTotalMass("starter")/2,b=this.getTotalMass("water"),c=this.getTotalMass("flour"),d=a/(c+a);return{hydration:as_percent((b+a)/(c+a)),inoculation:as_percent(d),flour_mass:c+a,doubling:truncate(-3*Math.log(d)/Math.log(2)),temp:72}},flour_mass:function(){return this.getTotalMass("flour")+this.getTotalMass("starter")/2},water_mass:function(){return this.getTotalMass("water")+this.getTotalMass("starter")/2},initialize:function(){}}),App.Models.Note=Backbone.Model.extend({initialize:function(){this.view=new App.Views.Note({model:this,id:"note_"+this.id})}}),App.Collections.NoteList=Backbone.Collection.extend({model:App.Models.Note,initialize:function(){},newNote:function(){var a=$("#new-note-body").val();if(!a)return;var b=this.create({time:(new Date).toUTCString(),body:$("#new-note-body").val()});$("#new-note-body").val("")}}),App.Collections.Recipes=Backbone.Collection.extend({model:App.Models.Recipe,url:"/recipes"});